generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clerk_id                  String?    @unique @db.VarChar(255)
  email                     String     @unique @db.VarChar(255)
  password_hash             String?    @db.VarChar(255)
  password_hint             String?    @db.VarChar(255)
  first_name                String?    @db.VarChar(100)
  last_name                 String?    @db.VarChar(100)
  avatar_url                String?
  role                      String     @default("student") @db.VarChar(20)
  school_id                 String?    @db.Uuid
  email_notifications       Boolean?   @default(true)
  progress_emails           Boolean?   @default(true)
  marketing_emails          Boolean?   @default(false)
  created_at                DateTime?  @default(now()) @db.Timestamp(6)
  last_login                DateTime?  @db.Timestamp(6)
  is_active                 Boolean?   @default(true)
  gdpr_consent              Boolean?   @default(false)
  gdpr_consent_date         DateTime?  @db.Timestamp(6)
  data_processing_agreement Boolean?   @default(false)

  school                    School?    @relation(fields: [school_id], references: [id])
  lesson_progress           LessonProgress[]
  classes_taught            Class[]    @relation("ClassTeacher")
  enrollments               ClassEnrollment[]
  patterns                  SavedPattern[]
  certificates              Certificate[]
  reset_tokens              PasswordResetToken[]

  @@map("users")
}

model School {
  id                String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name              String  @db.VarChar(255)
  domain            String? @db.VarChar(255)
  country           String? @default("GB") @db.VarChar(2)
  license_tier      String  @default("small") @db.VarChar(20)
  max_students      Int     @default(50)
  license_start     DateTime @db.Date
  license_end       DateTime @db.Date
  status            String? @default("active") @db.VarChar(20)
  monthly_price_gbp Decimal? @db.Decimal(10,2)
  billing_email     String? @db.VarChar(255)
  billing_address   String?
  vat_number        String? @db.VarChar(50)
  created_at        DateTime? @default(now()) @db.Timestamp(6)
  updated_at        DateTime? @default(now()) @db.Timestamp(6)
  notes             String?

  users             User[]
  classes           Class[]

  @@map("schools")
}

model Class {
  id            String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  school_id     String  @db.Uuid
  teacher_id    String  @db.Uuid
  name          String  @db.VarChar(255)
  description   String?
  class_code    String  @unique @db.VarChar(20)
  max_students  Int?    @default(30)
  is_archived   Boolean? @default(false)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
  academic_year String? @db.VarChar(20)

  school        School @relation(fields: [school_id], references: [id])
  teacher       User   @relation("ClassTeacher", fields: [teacher_id], references: [id])
  enrollments   ClassEnrollment[]

  @@map("classes")
}

model ClassEnrollment {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  class_id    String   @db.Uuid
  student_id  String   @db.Uuid
  enrolled_at DateTime? @default(now()) @db.Timestamp(6)
  status      String?  @default("active") @db.VarChar(20)

  class       Class @relation(fields: [class_id], references: [id])
  student     User  @relation(fields: [student_id], references: [id])

  @@unique([class_id, student_id])
  @@map("class_enrollments")
}

model LessonProgress {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id               String   @db.Uuid
  lesson_key            String   @db.VarChar(100)
  status                String?  @default("not_started") @db.VarChar(20)
  completion_percentage Int?     @default(0)
  time_spent_seconds    Int?     @default(0)
  started_at            DateTime? @db.Timestamp(6)
  completed_at          DateTime? @db.Timestamp(6)
  last_accessed         DateTime? @default(now()) @db.Timestamp(6)
  module_name           String?  @db.VarChar(100)
  lesson_number         Int?

  user User @relation(fields: [user_id], references: [id])

  @@unique([user_id, lesson_key])
  @@map("lesson_progress")
}

model SavedPattern {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id      String   @db.Uuid
  pattern_type String   @db.VarChar(50)
  pattern_name String?  @db.VarChar(255)
  pattern_data Json
  lesson_key   String?  @db.VarChar(100)
  is_favorite  Boolean? @default(false)
  created_at   DateTime? @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @default(now()) @db.Timestamp(6)

  user User @relation(fields: [user_id], references: [id])

  @@map("saved_patterns")
}

model Certificate {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id           String   @db.Uuid
  certificate_type  String   @db.VarChar(50)
  module_name       String?  @db.VarChar(100)
  certificate_url   String?
  certificate_code  String   @unique @db.VarChar(50)
  issued_at         DateTime? @default(now()) @db.Timestamp(6)
  completed_lessons Int?
  total_time_hours  Decimal? @db.Decimal(10,2)

  user User @relation(fields: [user_id], references: [id])

  @@map("certificates")
}

model PasswordResetToken {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique @db.VarChar(255)
  expires_at DateTime @db.Timestamp(6)
  used_at    DateTime? @db.Timestamp(6)
  created_at DateTime? @default(now()) @db.Timestamp(6)

  user User @relation(fields: [user_id], references: [id])

  @@map("password_reset_tokens")
}
