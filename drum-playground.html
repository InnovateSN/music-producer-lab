<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Drum Playground | Music Producer Lab</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="description" content="Create, customize, and export your own drum loops with the Music Producer Lab Drum Playground." />
    <meta name="theme-color" content="#030508">
    <link rel="icon" type="image/svg+xml" href="mpl-favicon.svg">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <style>
      .playground-header {
        text-align: center;
        margin-bottom: var(--space-2xl);
        padding: var(--space-2xl) 0;
        background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
        border-radius: 16px;
      }

      .playground-title {
        font-size: 3rem;
        font-weight: 800;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: var(--space-sm);
      }

      .playground-subtitle {
        font-size: 1.25rem;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
      }

      .control-panel {
        display: flex;
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
        padding: var(--space-lg);
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
      }

      .control-group label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .tempo-display {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-primary);
      }

      .sample-picker-container {
        margin-top: var(--space-md);
        padding: var(--space-md);
        background: var(--bg-tertiary, #050810);
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }

      .sample-picker-row {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-sm);
        padding: var(--space-sm);
        background: var(--bg-secondary);
        border-radius: 6px;
      }

      .sample-picker-label {
        min-width: 80px;
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-primary);
      }

      .sample-picker-select {
        flex: 1;
        padding: var(--space-sm);
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.875rem;
        cursor: pointer;
        transition: border-color 0.2s;
      }

      .sample-picker-select:hover {
        border-color: var(--accent-primary);
      }

      .sample-picker-select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .export-section {
        margin-top: var(--space-2xl);
        padding: var(--space-xl);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 12px;
        text-align: center;
      }

      .export-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: var(--space-sm);
        color: var(--text-primary);
      }

      .export-description {
        color: var(--text-secondary);
        margin-bottom: var(--space-lg);
      }

      .btn-export {
        padding: var(--space-md) var(--space-xl);
        font-size: 1.125rem;
        font-weight: 700;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }

      .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
      }

      .btn-export:active {
        transform: translateY(0);
      }

      .btn-export:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .export-status {
        margin-top: var(--space-md);
        padding: var(--space-md);
        background: var(--bg-secondary);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      /* Sequencer additional styles */
      #playground-sequencer {
        background: var(--bg-secondary);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: var(--space-lg);
      }

      .sequencer-row {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-sm);
      }

      .sequencer-label {
        min-width: 80px;
        font-weight: 600;
        font-size: 0.875rem;
        text-align: left;
      }

      .sequencer-grid {
        display: flex;
        gap: 4px;
        flex: 1;
      }

      .sequencer-step {
        flex: 1;
        min-width: 30px;
        height: 40px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: all 0.2s;
      }

      .sequencer-step:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: #00d4ff;
      }

      .sequencer-step.active {
        border-color: transparent;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.5);
      }

      .sequencer-step.playing {
        box-shadow: 0 0 20px #00d4ff;
        transform: scale(1.05);
      }

      @media (max-width: 768px) {
        .playground-title {
          font-size: 2rem;
        }

        .control-panel {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div id="navbar-placeholder"></div>

    <main class="main-content container">

      <!-- PLAYGROUND HEADER -->
      <div class="playground-header">
        <h1 class="playground-title">ü•Å Drum Playground</h1>
        <p class="playground-subtitle">
          Create custom drum loops, choose your samples, and export your beats as WAV files
        </p>
      </div>

      <!-- CONTROL PANEL -->
      <div class="control-panel">
        <div class="control-group">
          <label>Tempo</label>
          <div class="tempo-display" id="playground-tempo-display">120 BPM</div>
        </div>

        <div class="control-group">
          <label>Tempo Control</label>
          <input type="range" id="playground-tempo-slider" min="60" max="200" value="120" style="width: 200px;">
        </div>

        <div class="control-group">
          <label>Swing</label>
          <div class="tempo-display" id="playground-swing-display" style="font-size: 1.2rem;">0%</div>
        </div>

        <div class="control-group">
          <label>Swing Control</label>
          <input type="range" id="playground-swing-slider" min="0" max="100" value="0" style="width: 200px;">
        </div>

        <div style="flex: 1;"></div>

        <button type="button" class="btn btn-outline" id="playground-play">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px;">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          <span>Play</span>
        </button>

        <button type="button" class="btn btn-outline" id="playground-stop">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px;">
            <rect x="6" y="4" width="4" height="16"/>
            <rect x="14" y="4" width="4" height="16"/>
          </svg>
          <span>Stop</span>
        </button>

        <button type="button" class="btn btn-outline" id="playground-clear">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;">
            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
          </svg>
          <span>Clear All</span>
        </button>
      </div>

      <!-- SAMPLE PICKER SECTION -->
      <section style="margin-bottom: var(--space-2xl);">
        <h2 class="section-title" style="margin-bottom: var(--space-md);">üéõÔ∏è Sample Selection</h2>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
          Customize your drum kit by choosing different samples for each instrument
        </p>
        <div class="sample-picker-container" id="sample-picker-container">
          <!-- Sample pickers will be populated by JavaScript -->
        </div>
      </section>

      <!-- SEQUENCER SECTION -->
      <section style="margin-bottom: var(--space-2xl);">
        <h2 class="section-title" style="margin-bottom: var(--space-lg);">üéπ 16-Step Sequencer</h2>
        <div class="sequencer" id="playground-sequencer">
          <!-- Sequencer will be created by JS -->
        </div>
      </section>

      <!-- MIXER SECTION -->
      <section style="margin-bottom: var(--space-2xl);">
        <h2 class="section-title" style="margin-bottom: var(--space-lg);">üéöÔ∏è Mixer</h2>
        <div id="playground-mixer" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: var(--space-lg);">
          <!-- Mixer channels will be created by JS -->
        </div>
      </section>

      <!-- HUMANIZATION SECTION -->
      <section style="margin-bottom: var(--space-2xl);">
        <h2 class="section-title" style="margin-bottom: var(--space-md);">üé≠ Humanization</h2>
        <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(0, 240, 255, 0.1)); border: 1px solid rgba(138, 43, 226, 0.3); border-radius: 12px; padding: var(--space-lg);">

          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="humanize-enable" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 0.9rem; color: var(--text-secondary);">Enable Humanization</span>
            </label>
          </div>

          <div id="humanize-controls" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s ease;">
            <!-- Timing Randomization -->
            <div style="margin-bottom: 16px;">
              <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-secondary);">
                  Timing Randomization
                </span>
                <span id="timing-value" style="font-family: var(--font-mono, monospace); font-size: 0.85rem; color: #00f0ff;">
                  0ms
                </span>
              </label>
              <input type="range" id="timing-slider" min="0" max="50" step="1" value="0"
                style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, rgba(0, 240, 255, 0.2), rgba(138, 43, 226, 0.2)); outline: none; cursor: pointer;">
              <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-top: 4px;">
                <span>0ms</span>
                <span>25ms</span>
                <span>50ms</span>
              </div>
            </div>

            <!-- Velocity Randomization -->
            <div style="margin-bottom: 20px;">
              <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-secondary);">
                  Velocity Randomization
                </span>
                <span id="velocity-rand-value" style="font-family: var(--font-mono, monospace); font-size: 0.85rem; color: #00f0ff;">
                  0%
                </span>
              </label>
              <input type="range" id="velocity-rand-slider" min="0" max="50" step="1" value="0"
                style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, rgba(0, 240, 255, 0.2), rgba(138, 43, 226, 0.2)); outline: none; cursor: pointer;">
              <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-top: 4px;">
                <span>0%</span>
                <span>25%</span>
                <span>50%</span>
              </div>
            </div>

            <!-- Presets -->
            <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 16px;">
              <div style="font-size: 0.85rem; font-weight: 600; color: #888; margin-bottom: 10px;">
                Humanization Presets:
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                <button type="button" class="humanize-preset-btn" data-timing="8" data-velocity="15"
                  style="padding: 8px 12px; background: rgba(0, 240, 255, 0.1); border: 1px solid rgba(0, 240, 255, 0.3); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                  <div style="margin-bottom: 2px;">Subtle</div>
                  <div style="font-size: 0.7rem; font-weight: 400; color: #666;">8ms / 15%</div>
                </button>
                <button type="button" class="humanize-preset-btn" data-timing="15" data-velocity="25"
                  style="padding: 8px 12px; background: rgba(0, 240, 255, 0.1); border: 1px solid rgba(0, 240, 255, 0.3); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                  <div style="margin-bottom: 2px;">MPC 60</div>
                  <div style="font-size: 0.7rem; font-weight: 400; color: #666;">15ms / 25%</div>
                </button>
                <button type="button" class="humanize-preset-btn" data-timing="30" data-velocity="35"
                  style="padding: 8px 12px; background: rgba(0, 240, 255, 0.1); border: 1px solid rgba(0, 240, 255, 0.3); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                  <div style="margin-bottom: 2px;">Loose</div>
                  <div style="font-size: 0.7rem; font-weight: 400; color: #666;">30ms / 35%</div>
                </button>
                <button type="button" class="humanize-preset-btn" data-timing="20" data-velocity="40"
                  style="padding: 8px 12px; background: rgba(0, 240, 255, 0.1); border: 1px solid rgba(0, 240, 255, 0.3); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                  <div style="margin-bottom: 2px;">Live</div>
                  <div style="font-size: 0.7rem; font-weight: 400; color: #666;">20ms / 40%</div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- EXPORT SECTION -->
      <section class="export-section">
        <h2 class="export-title">üíæ Export Your Loop</h2>
        <p class="export-description">
          Download your drum loop as a high-quality WAV file
        </p>
        <button type="button" class="btn-export" id="export-wav-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;margin-right:8px;vertical-align:middle;">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
          </svg>
          Export as WAV
        </button>
        <div class="export-status" id="export-status" style="display: none;">
          <!-- Export status messages -->
        </div>
      </section>

    </main>

    <!-- FOOTER -->
    <footer class="site-footer">
      <div class="container footer-grid">
        <p class="copyright">¬© <span id="mpl-year">2025</span> Music Producer Lab</p>
        <nav class="footer-nav">
          <a href="labs.html">Labs</a>
          <a href="index.html">Home</a>
        </nav>
      </div>
    </footer>

    <!-- Core Scripts -->
    <script type="module">
      import { playSound, setMixerVolume, setMixerPan, getMixerState, changeSample, sampleLibrary, selectedSamples, setMeterUpdateCallback, waitForSampleLibrary, initMixer } from './sequencer.js';

      // ==========================================
      // DRUM PLAYGROUND INITIALIZATION
      // ==========================================

      const instruments = [
        { id: 'kick', label: 'Kick', row: 0 },
        { id: 'snare', label: 'Snare', row: 1 },
        { id: 'hihat', label: 'Hi-Hat', row: 2 },
        { id: 'clap', label: 'Clap', row: 3 },
        { id: 'tom', label: 'Tom', row: 4 },
        { id: 'rim', label: 'Rim', row: 5 },
        { id: 'crash', label: 'Crash', row: 6 }
      ];

      const stepCount = 16;
      let isPlaying = false;
      let currentStep = -1;
      let playbackInterval = null;
      let tempo = 120;
      let swing = 0;

      // Humanization state
      let humanizationEnabled = false;
      let timingRandomization = 0;
      let velocityRandomization = 0;

      // Pattern data
      const pattern = {};
      instruments.forEach(inst => {
        pattern[inst.id] = Array(stepCount).fill(false);
      });

      // ==========================================
      // SAMPLE PICKER UI
      // ==========================================

      function initSamplePickers() {
        const container = document.getElementById('sample-picker-container');
        if (!container) return;

        container.innerHTML = '';

        instruments.forEach(inst => {
          const samples = sampleLibrary[inst.id] || [];
          if (samples.length === 0) return;

          const row = document.createElement('div');
          row.className = 'sample-picker-row';

          const label = document.createElement('div');
          label.className = 'sample-picker-label';
          label.textContent = inst.label;

          const select = document.createElement('select');
          select.className = 'sample-picker-select';
          select.id = `sample-select-${inst.id}`;

          samples.forEach(sample => {
            const option = document.createElement('option');
            option.value = sample.path;
            option.textContent = sample.name;

            // Check if this is the currently selected sample
            if (selectedSamples[inst.id] === sample.path) {
              option.selected = true;
            }

            select.appendChild(option);
          });

          // Add change event listener
          select.addEventListener('change', (e) => {
            changeSample(inst.id, e.target.value);
            console.log(`Changed ${inst.id} sample to:`, e.target.value);
          });

          row.appendChild(label);
          row.appendChild(select);
          container.appendChild(row);
        });
      }

      // ==========================================
      // SEQUENCER UI
      // ==========================================

      function initSequencer() {
        const container = document.getElementById('playground-sequencer');
        if (!container) {
          console.error('‚ùå Sequencer container not found!');
          return;
        }

        container.innerHTML = '';

        // Color palette for different instruments
        const instrumentColors = {
          'kick': '#ff5a3d',
          'snare': '#5f4dff',
          'hihat': '#00d4ff',
          'hat': '#00d4ff',
          'clap': '#f59e0b',
          'tom': '#a855f7',
          'rim': '#10b981',
          'crash': '#ec4899'
        };

        console.log(`üéπ Creating sequencer for ${instruments.length} instruments, ${stepCount} steps each`);

        // Add step numbers header
        const headerRow = document.createElement('div');
        headerRow.style.cssText = 'display: flex; align-items: center; gap: var(--space-md); margin-bottom: 8px;';

        const headerLabel = document.createElement('div');
        headerLabel.style.cssText = 'min-width: 80px;';
        headerRow.appendChild(headerLabel);

        const stepNumbersContainer = document.createElement('div');
        stepNumbersContainer.style.cssText = 'display: flex; gap: 4px; flex: 1;';

        for (let i = 0; i < stepCount; i++) {
          const stepNum = document.createElement('div');
          stepNum.style.cssText = `
            flex: 1;
            min-width: 30px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: ${i % 4 === 0 ? '700' : '400'};
            color: ${i % 4 === 0 ? '#00d4ff' : '#666'};
            font-family: var(--font-mono, monospace);
          `;
          stepNum.textContent = i + 1;
          stepNumbersContainer.appendChild(stepNum);
        }

        headerRow.appendChild(stepNumbersContainer);
        container.appendChild(headerRow);

        // Add beat markers (1, 2, 3, 4)
        const beatRow = document.createElement('div');
        beatRow.style.cssText = 'display: flex; align-items: center; gap: var(--space-md); margin-bottom: 12px;';

        const beatLabel = document.createElement('div');
        beatLabel.style.cssText = 'min-width: 80px; font-size: 0.75rem; color: #888;';
        beatLabel.textContent = 'Beat';
        beatRow.appendChild(beatLabel);

        const beatMarkersContainer = document.createElement('div');
        beatMarkersContainer.style.cssText = 'display: flex; gap: 4px; flex: 1;';

        for (let beat = 1; beat <= 4; beat++) {
          const beatGroup = document.createElement('div');
          beatGroup.style.cssText = 'flex: 1; display: flex; gap: 4px;';

          for (let sub = 0; sub < 4; sub++) {
            const marker = document.createElement('div');
            marker.style.cssText = `
              flex: 1;
              min-width: 30px;
              height: 4px;
              background: ${sub === 0 ? '#00d4ff' : 'rgba(255,255,255,0.1)'};
              border-radius: 2px;
            `;
            beatGroup.appendChild(marker);
          }

          beatMarkersContainer.appendChild(beatGroup);
        }

        beatRow.appendChild(beatMarkersContainer);
        container.appendChild(beatRow);

        instruments.forEach(inst => {
          const color = instrumentColors[inst.id] || '#00d4ff';

          const row = document.createElement('div');
          row.className = 'sequencer-row';
          row.dataset.instrument = inst.id;

          const label = document.createElement('div');
          label.className = 'sequencer-label';
          label.textContent = inst.label;
          label.style.color = color;
          row.appendChild(label);

          const grid = document.createElement('div');
          grid.className = 'sequencer-grid';

          for (let i = 0; i < stepCount; i++) {
            const cell = document.createElement('button');
            cell.className = 'sequencer-step';
            cell.dataset.step = i;
            cell.dataset.instrument = inst.id;
            cell.setAttribute('aria-label', `${inst.label} step ${i + 1}`);

            cell.addEventListener('click', () => {
              pattern[inst.id][i] = !pattern[inst.id][i];
              cell.classList.toggle('active', pattern[inst.id][i]);

              // Update background color
              if (pattern[inst.id][i]) {
                cell.style.background = color;
                playSound(inst.id, 100); // MIDI velocity (0-127)
              } else {
                cell.style.background = '';
              }
            });

            grid.appendChild(cell);
          }

          row.appendChild(grid);
          container.appendChild(row);
        });

        console.log(`‚úÖ Sequencer created: ${container.querySelectorAll('.sequencer-step').length} total cells`);
      }

      // ==========================================
      // MIXER UI
      // ==========================================

      function initMixerUI() {
        const container = document.getElementById('playground-mixer');
        if (!container) return;

        const channelsContainer = document.createElement('div');
        channelsContainer.className = 'mixer-channels';

        // Color palette
        const instrumentColors = {
          'kick': '#ff5a3d',
          'snare': '#5f4dff',
          'hihat': '#00d4ff',
          'clap': '#f59e0b',
          'tom': '#a855f7',
          'rim': '#10b981',
          'crash': '#ec4899'
        };

        // Meter animation state
        const meterLevels = {};
        const meterPeaks = {};
        const meterDecayIntervals = {};

        // Register meter callback
        setMeterUpdateCallback((instrument, level) => {
          meterLevels[instrument] = level * 100;

          if (!meterPeaks[instrument] || level * 100 > meterPeaks[instrument]) {
            meterPeaks[instrument] = level * 100;
          }

          const meterFill = document.getElementById(`meter-${instrument}`);
          const meterPeak = document.getElementById(`peak-${instrument}`);

          if (meterFill) {
            meterFill.style.height = `${level * 100}%`;
          }
          if (meterPeak && meterPeaks[instrument]) {
            meterPeak.style.bottom = `${meterPeaks[instrument]}%`;
          }

          if (meterDecayIntervals[instrument]) {
            clearInterval(meterDecayIntervals[instrument]);
          }

          meterDecayIntervals[instrument] = setInterval(() => {
            if (meterLevels[instrument] > 0) {
              meterLevels[instrument] = Math.max(0, meterLevels[instrument] - 5);
              if (meterFill) {
                meterFill.style.height = `${meterLevels[instrument]}%`;
              }
            }

            if (meterPeaks[instrument] > 0) {
              meterPeaks[instrument] = Math.max(0, meterPeaks[instrument] - 1.5);
              if (meterPeak) {
                meterPeak.style.bottom = `${meterPeaks[instrument]}%`;
              }
            }

            if (meterLevels[instrument] <= 0 && meterPeaks[instrument] <= 0) {
              clearInterval(meterDecayIntervals[instrument]);
              meterDecayIntervals[instrument] = null;
            }
          }, 50);

          // UPDATE MASTER METER
          const masterLevel = Math.min(100, level * 100);

          if (!meterLevels['master']) meterLevels['master'] = 0;
          if (!meterPeaks['master']) meterPeaks['master'] = 0;

          meterLevels['master'] = Math.min(100, meterLevels['master'] + masterLevel * 0.3);

          if (meterLevels['master'] > meterPeaks['master']) {
            meterPeaks['master'] = meterLevels['master'];
          }

          const masterMeterFill = document.getElementById('meter-master');
          const masterMeterPeak = document.getElementById('peak-master');

          if (masterMeterFill) {
            masterMeterFill.style.height = `${meterLevels['master']}%`;
          }
          if (masterMeterPeak) {
            masterMeterPeak.style.bottom = `${meterPeaks['master']}%`;
          }

          if (meterDecayIntervals['master']) {
            clearInterval(meterDecayIntervals['master']);
          }

          meterDecayIntervals['master'] = setInterval(() => {
            if (meterLevels['master'] > 0) {
              meterLevels['master'] = Math.max(0, meterLevels['master'] - 5);
              if (masterMeterFill) {
                masterMeterFill.style.height = `${meterLevels['master']}%`;
              }
            }

            if (meterPeaks['master'] > 0) {
              meterPeaks['master'] = Math.max(0, meterPeaks['master'] - 1.5);
              if (masterMeterPeak) {
                masterMeterPeak.style.bottom = `${meterPeaks['master']}%`;
              }
            }

            if (meterLevels['master'] <= 0 && meterPeaks['master'] <= 0) {
              clearInterval(meterDecayIntervals['master']);
              meterDecayIntervals['master'] = null;
            }
          }, 50);
        });

        instruments.forEach(inst => {
          const mixerState = getMixerState(inst.id);
          const color = instrumentColors[inst.id] || '#00d4ff';

          const channel = document.createElement('div');
          channel.className = 'channel-strip';

          channel.innerHTML = `
            <div class="channel-name" style="background: linear-gradient(180deg, ${color}40 0%, ${color}10 100%); border-bottom: 2px solid ${color};">
              ${inst.label}
            </div>

            <div class="channel-meter">
              <div class="meter-fill" id="meter-${inst.id}" style="height: 0%"></div>
              <div class="meter-peak" id="peak-${inst.id}" style="bottom: 0%"></div>
            </div>

            <div class="channel-fader-container">
              <input type="range" class="vertical-slider" id="mixer-vol-${inst.id}"
                     min="0" max="100" value="${(mixerState.volume * 100).toFixed(0)}"
                     orient="vertical" style="height: 140px;">
              <span class="fader-value" id="mixer-vol-value-${inst.id}">
                ${volumeToDb(mixerState.volume)}
              </span>
            </div>

            <div class="channel-pan">
              <span class="pan-label">PAN</span>
              <input type="range" id="mixer-pan-${inst.id}"
                     min="-100" max="100" value="${(mixerState.pan * 100).toFixed(0)}"
                     style="width: 70px;">
              <span class="pan-label" id="mixer-pan-value-${inst.id}">
                ${panToText(mixerState.pan)}
              </span>
            </div>

            <div class="channel-controls">
              <button class="channel-btn mute" id="mixer-mute-${inst.id}" title="Mute">M</button>
              <button class="channel-btn solo" id="mixer-solo-${inst.id}" title="Solo">S</button>
            </div>
          `;

          const volSlider = channel.querySelector(`#mixer-vol-${inst.id}`);
          const volValue = channel.querySelector(`#mixer-vol-value-${inst.id}`);
          const panSlider = channel.querySelector(`#mixer-pan-${inst.id}`);
          const panValue = channel.querySelector(`#mixer-pan-value-${inst.id}`);

          volSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value) / 100;
            setMixerVolume(inst.id, volume);
            volValue.textContent = volumeToDb(volume);
          });

          panSlider.addEventListener('input', (e) => {
            const pan = parseFloat(e.target.value) / 100;
            setMixerPan(inst.id, pan);
            panValue.textContent = panToText(pan);
          });

          channelsContainer.appendChild(channel);
        });

        // Add MASTER channel
        const masterChannel = document.createElement('div');
        masterChannel.className = 'channel-strip master-channel';
        masterChannel.style.cssText = 'min-width: 130px; max-width: 130px; border: 2px solid #fbbf24;';

        const masterColor = '#fbbf24';
        masterChannel.innerHTML = `
          <div class="channel-name" style="background: linear-gradient(180deg, ${masterColor}60 0%, ${masterColor}20 100%); border-bottom: 3px solid ${masterColor}; font-size: 0.85rem; font-weight: 800; letter-spacing: 0.05em;">
            MASTER
          </div>

          <div class="channel-meter" style="height: 200px;">
            <div class="meter-fill" id="meter-master" style="height: 0%"></div>
            <div class="meter-peak" id="peak-master" style="bottom: 0%"></div>
          </div>

          <div class="channel-fader-container">
            <div class="fader-value" style="font-size: 1rem; font-weight: 700; color: ${masterColor}; text-shadow: 0 0 8px ${masterColor};">
              0.0 dB
            </div>
          </div>

          <div style="height: 80px; display: flex; align-items: center; justify-content: center;">
            <div style="font-size: 0.65rem; color: #64748b; text-align: center;">
              Mix Output
            </div>
          </div>
        `;

        channelsContainer.appendChild(masterChannel);
        container.appendChild(channelsContainer);
      }

      function volumeToDb(volume) {
        if (volume === 0) return '-‚àû dB';
        const db = 20 * Math.log10(volume);
        return db.toFixed(1) + ' dB';
      }

      function panToText(pan) {
        if (pan === 0) return 'C';
        if (pan < 0) return 'L' + Math.abs(Math.round(pan * 100));
        return 'R' + Math.round(pan * 100);
      }

      // ==========================================
      // PLAYBACK CONTROL
      // ==========================================

      function play() {
        if (isPlaying) return;

        isPlaying = true;
        currentStep = -1;

        const baseStepTime = (60 / tempo) * 1000 / (stepCount / 4); // Step duration in ms

        const playStep = () => {
          // Calculate swing delay
          let stepDelay = baseStepTime;
          if (swing > 0) {
            if (currentStep % 2 === 0) {
              stepDelay = baseStepTime * (1 + (swing / 100) * 0.5);
            } else {
              stepDelay = baseStepTime * (1 - (swing / 100) * 0.5);
            }
          }

          // Clear previous step highlight
          document.querySelectorAll('.sequencer-step.playing').forEach(cell => {
            cell.classList.remove('playing');
          });

          // Advance step
          currentStep = (currentStep + 1) % stepCount;

          // Highlight current step
          document.querySelectorAll(`.sequencer-step[data-step="${currentStep}"]`).forEach(cell => {
            cell.classList.add('playing');
          });

          // Play sounds for active steps with humanization
          instruments.forEach(inst => {
            if (pattern[inst.id][currentStep]) {
              let velocity = 100;
              let timingOffset = 0;

              // Apply humanization if enabled
              if (humanizationEnabled) {
                // Velocity humanization
                const velocityVariation = (Math.random() - 0.5) * 2 * (velocityRandomization / 100) * velocity;
                velocity = Math.max(1, Math.min(127, Math.round(velocity + velocityVariation)));

                // Timing humanization
                timingOffset = (Math.random() - 0.5) * 2 * timingRandomization;
              }

              playSound(inst.id, velocity, timingOffset);
            }
          });

          if (isPlaying) {
            playbackInterval = setTimeout(playStep, stepDelay);
          }
        };

        playStep();
      }

      function stop() {
        if (!isPlaying) return;

        isPlaying = false;
        clearInterval(playbackInterval);
        currentStep = -1;

        // Clear all playing highlights
        document.querySelectorAll('.sequencer-step.playing').forEach(cell => {
          cell.classList.remove('playing');
        });
      }

      function clearPattern() {
        instruments.forEach(inst => {
          pattern[inst.id].fill(false);
        });

        document.querySelectorAll('.sequencer-step.active').forEach(cell => {
          cell.classList.remove('active');
          cell.style.background = '';
        });
      }

      // ==========================================
      // WAV EXPORT FUNCTIONALITY
      // ==========================================

      async function exportToWav() {
        const exportBtn = document.getElementById('export-wav-btn');
        const exportStatus = document.getElementById('export-status');

        try {
          exportBtn.disabled = true;
          exportStatus.style.display = 'block';
          exportStatus.textContent = 'üéµ Rendering your loop...';

          // Import necessary functions
          const { renderPatternToWav } = await import('./wav-export.js');

          // Render the pattern
          const wavBlob = await renderPatternToWav(pattern, instruments, tempo, stepCount);

          // Create download link
          const url = URL.createObjectURL(wavBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `drum-loop-${tempo}bpm-${Date.now()}.wav`;
          a.click();

          URL.revokeObjectURL(url);

          exportStatus.textContent = '‚úÖ Loop exported successfully!';
          setTimeout(() => {
            exportStatus.style.display = 'none';
          }, 3000);

        } catch (error) {
          console.error('Export error:', error);
          exportStatus.textContent = '‚ùå Export failed: ' + error.message;
        } finally {
          exportBtn.disabled = false;
        }
      }

      // ==========================================
      // EVENT LISTENERS
      // ==========================================

      document.getElementById('playground-play').addEventListener('click', play);
      document.getElementById('playground-stop').addEventListener('click', stop);
      document.getElementById('playground-clear').addEventListener('click', clearPattern);
      document.getElementById('export-wav-btn').addEventListener('click', exportToWav);

      // Tempo control
      const tempoSlider = document.getElementById('playground-tempo-slider');
      const tempoDisplay = document.getElementById('playground-tempo-display');

      tempoSlider.addEventListener('input', (e) => {
        tempo = parseInt(e.target.value);
        tempoDisplay.textContent = `${tempo} BPM`;

        // Restart playback if currently playing
        if (isPlaying) {
          stop();
          play();
        }
      });

      // Swing control
      const swingSlider = document.getElementById('playground-swing-slider');
      const swingDisplay = document.getElementById('playground-swing-display');

      swingSlider.addEventListener('input', (e) => {
        swing = parseInt(e.target.value);
        swingDisplay.textContent = `${swing}%`;

        // Restart playback if currently playing
        if (isPlaying) {
          stop();
          play();
        }
      });

      // Humanization controls
      const humanizeEnableCheckbox = document.getElementById('humanize-enable');
      const humanizeControlsDiv = document.getElementById('humanize-controls');
      const timingSlider = document.getElementById('timing-slider');
      const timingValue = document.getElementById('timing-value');
      const velocityRandSlider = document.getElementById('velocity-rand-slider');
      const velocityRandValue = document.getElementById('velocity-rand-value');
      const presetButtons = document.querySelectorAll('.humanize-preset-btn');

      // Enable/disable humanization
      if (humanizeEnableCheckbox) {
        humanizeEnableCheckbox.addEventListener('change', (e) => {
          humanizationEnabled = e.target.checked;

          if (humanizeControlsDiv) {
            if (humanizationEnabled) {
              humanizeControlsDiv.style.opacity = '1';
              humanizeControlsDiv.style.pointerEvents = 'auto';
            } else {
              humanizeControlsDiv.style.opacity = '0.5';
              humanizeControlsDiv.style.pointerEvents = 'none';
            }
          }
        });
      }

      // Timing randomization slider
      if (timingSlider && timingValue) {
        timingSlider.addEventListener('input', (e) => {
          timingRandomization = parseFloat(e.target.value);
          timingValue.textContent = `${timingRandomization}ms`;
        });
      }

      // Velocity randomization slider
      if (velocityRandSlider && velocityRandValue) {
        velocityRandSlider.addEventListener('input', (e) => {
          velocityRandomization = parseFloat(e.target.value);
          velocityRandValue.textContent = `${velocityRandomization}%`;
        });
      }

      // Preset buttons
      presetButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const timing = parseFloat(btn.dataset.timing);
          const velocity = parseFloat(btn.dataset.velocity);

          timingRandomization = timing;
          velocityRandomization = velocity;

          if (timingSlider) timingSlider.value = timing;
          if (timingValue) timingValue.textContent = `${timing}ms`;
          if (velocityRandSlider) velocityRandSlider.value = velocity;
          if (velocityRandValue) velocityRandValue.textContent = `${velocity}%`;

          // Enable humanization if not already enabled
          if (!humanizationEnabled && humanizeEnableCheckbox) {
            humanizeEnableCheckbox.checked = true;
            humanizationEnabled = true;
            if (humanizeControlsDiv) {
              humanizeControlsDiv.style.opacity = '1';
              humanizeControlsDiv.style.pointerEvents = 'auto';
            }
          }

          // Visual feedback
          btn.style.background = 'rgba(0, 255, 157, 0.2)';
          btn.style.borderColor = 'rgba(0, 255, 157, 0.5)';
          setTimeout(() => {
            btn.style.background = 'rgba(0, 240, 255, 0.1)';
            btn.style.borderColor = 'rgba(0, 240, 255, 0.3)';
          }, 300);
        });
      });

      // ==========================================
      // INITIALIZATION
      // ==========================================

      // Wait for sample library to load, then initialize everything
      async function initialize() {
        try {
          console.log('‚è≥ Waiting for sample library...');
          await waitForSampleLibrary();
          console.log('‚úÖ Sample library loaded!');

          // Initialize mixer state for all instruments (from sequencer.js)
          initMixer(instruments);

          // Initialize UI components
          initSamplePickers();
          initSequencer();
          initMixerUI();

          console.log('‚úÖ Drum Playground initialized!');
        } catch (error) {
          console.error('‚ùå Initialization failed:', error);

          // Show error message to user
          const container = document.querySelector('.main-content');
          if (container) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
              background: rgba(239, 68, 68, 0.1);
              border: 1px solid rgba(239, 68, 68, 0.3);
              border-radius: 8px;
              padding: 16px;
              margin: 20px 0;
              color: #ef4444;
            `;
            errorDiv.innerHTML = `
              <strong>‚ö†Ô∏è Loading Error</strong><br>
              Failed to load drum samples. Please refresh the page to try again.
            `;
            container.insertBefore(errorDiv, container.firstChild);
          }
        }
      }

      // Start initialization
      initialize();

      // Set year in footer
      document.getElementById("mpl-year").textContent = new Date().getFullYear();
    </script>
    <script src="navbar.js"></script>
  </body>
</html>
