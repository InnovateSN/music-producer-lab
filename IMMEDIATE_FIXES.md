# üîß FIX IMMEDIATI - Music Producer Lab

## Questi fix risolvono gli errori bloccanti identificati nel VALIDATION_REPORT.md

---

## 1Ô∏è‚É£ RIMUOVERE FILE DUPLICATO `/api/gumroad-webhook.js`

**Problema:** Questo file non √® usato (il backend usa Express separato) e contiene codice non funzionante.

**Soluzione:**
```bash
git rm api/gumroad-webhook.js
git commit -m "Remove unused Vercel webhook (backend Express is used instead)"
git push origin main
```

---

## 2Ô∏è‚É£ AGGIUNGERE CAMPO `price` ALLO SCHEMA SUPABASE (Opzionale)

**Se vuoi tracciare il prezzo di acquisto:**

### Step 1: Aggiungi colonna in Supabase SQL Editor

```sql
-- Aggiungi colonna price (numeric per supportare decimali)
ALTER TABLE public.users 
ADD COLUMN IF NOT EXISTS price numeric(10, 2);

-- Commento per documentazione
COMMENT ON COLUMN public.users.price IS 'Prezzo di acquisto in valuta base (es. 99.00 per $99)';
```

### Step 2: Aggiorna backend webhook

**File:** `/backend/routes/gumroad-webhook.js`

Cerca questa sezione (linea 55-58):
```javascript
const email = req.body.email?.toLowerCase();
const purchaseId = req.body.purchase_id || req.body.sale_id;
const planTier = req.body.offer_name || req.body.product_name || "premium";
```

Aggiungi dopo:
```javascript
// Converti price da cents a dollari (Gumroad invia in cents)
const priceInCents = parseInt(req.body.price) || 0;
const price = priceInCents / 100;
```

Poi trova l'upsert (linea 96-107) e aggiungi `price`:
```javascript
const { error } = await supabase
  .from("users")
  .upsert(
    {
      email,
      has_paid: true,
      plan_tier: planTier,
      purchase_id: purchaseId,
      price: price,  // ‚Üê AGGIUNGERE QUESTO
      updated_at: new Date().toISOString(),
    },
    { onConflict: "email" }
  );
```

---

## 3Ô∏è‚É£ CONFIGURARE ENVIRONMENT VARIABLES SU VERCEL

### Step 1: Ottieni Anon Key da Supabase

1. Vai su https://supabase.com/dashboard/project/nmhmrucvsrhfnajagdyy
2. Settings ‚Üí API
3. Copia `anon` `public` key

### Step 2: Configura su Vercel

1. Vai su https://vercel.com/innovatesn/music-producer-lab/settings/environment-variables
2. Aggiungi:
   - Key: `SUPABASE_URL`  
     Value: `https://nmhmrucvsrhfnajagdyy.supabase.co`
   - Key: `SUPABASE_ANON_KEY`  
     Value: `[la key che hai copiato]`
3. Environment: `Production`, `Preview`, `Development`
4. Salva

### Step 3: Aggiorna file HTML

**File da modificare:**
- `/login.html`
- `/signup.html`
- `/members/dashboard.html`
- Qualsiasi pagina che usa Supabase

**Cerca questa riga:**
```html
<script src="./supabase-config.js"></script>
```

**Sostituisci con:**
```html
<script src="./supabase-config.js" 
  data-supabase-url="https://nmhmrucvsrhfnajagdyy.supabase.co"
  data-supabase-anon-key="[YOUR_ANON_KEY_HERE]">
</script>
```

**‚ö†Ô∏è IMPORTANTE:** Non committare l'anon key hardcoded! √à solo per test locale.

### Step 4: Soluzione Migliore - Creare script di build

**File:** `inject-env.js` (nuovo file alla root)

```javascript
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const SUPABASE_URL = process.env.SUPABASE_URL || 'MISSING_SUPABASE_URL';
const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY || 'MISSING_SUPABASE_ANON_KEY';

const envScript = `
// Auto-generated by inject-env.js
(function() {
  window.__SUPABASE_URL__ = "${SUPABASE_URL}";
  window.__SUPABASE_ANON_KEY__ = "${SUPABASE_ANON_KEY}";
  console.log("[MPL] Environment variables injected");
})();
`;

fs.writeFileSync(path.join(__dirname, 'public-env.js'), envScript);
console.log('‚úÖ Environment variables injected into public-env.js');
```

**File:** `package.json` (aggiorna)

```json
{
  "name": "music-producer-lab",
  "version": "1.0.0",
  "scripts": {
    "build": "node inject-env.js"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0"
  }
}
```

**Vercel Settings ‚Üí Build & Development:**
- Build Command: `npm run build`
- Output Directory: `.` (nessuna build necessaria per static site)

**Poi aggiorna HTML per includere:**
```html
<script src="./public-env.js"></script>
<script src="./supabase-config.js"></script>
```

---

## 4Ô∏è‚É£ AGGIUNGERE `GUMROAD_ACCESS_TOKEN` AL BACKEND

### Step 1: Ottieni Access Token da Gumroad

1. Vai su https://app.gumroad.com/settings/advanced
2. "Generate new application" ‚Üí Nome: "Music Producer Lab Webhook"
3. Copia l'access token generato

### Step 2: Aggiungi al .env

**File:** `/backend/.env`

```bash
SUPABASE_URL=https://nmhmrucvsrhfnajagdyy.supabase.co
SUPABASE_SERVICE_ROLE_KEY=sb_secret_kjGYEdsRw19bPhx525JXqA_sMhfwk18
GUMROAD_SECRET=KdDFb6uDI8EgNQJwHzQrU0==
GUMROAD_ACCESS_TOKEN=[YOUR_GUMROAD_ACCESS_TOKEN_HERE]  # ‚Üê AGGIUNGI QUESTO
```

### Step 3: Configura su Produzione

Se backend √® deployato su Railway/Render, aggiungi la variabile l√¨.

---

## 5Ô∏è‚É£ MIGLIORARE `/success.html` CON SYNC AUTOMATICA

**File:** `/success.html`

Aggiungi prima del `</body>`:

```html
<script src="./supabase-config.js"></script>
<script type="module">
  import { syncSupabasePremiumStatus } from "./supabase-access.js";
  import { setAuthState } from "./auth.js";
  
  const messageEl = document.getElementById('mpl-billing-message');
  
  // Funzione di polling per controllare attivazione premium
  async function checkPremiumStatus() {
    let attempts = 0;
    const maxAttempts = 12; // 1 minuto (5s * 12)
    
    const interval = setInterval(async () => {
      attempts++;
      
      try {
        const result = await syncSupabasePremiumStatus();
        
        if (result.isPremium) {
          clearInterval(interval);
          
          // Aggiorna messaggio
          messageEl.innerHTML = 
            '‚úÖ <strong>Account Premium attivato!</strong> Redirecting to dashboard...';
          
          // Salva stato auth
          setAuthState({
            email: result.session?.user?.email,
            hasPaid: true,
            planTier: result.profile?.plan_tier || 'premium'
          });
          
          // Redirect dopo 2 secondi
          setTimeout(() => {
            window.location.href = 'members/dashboard.html';
          }, 2000);
        }
      } catch (error) {
        console.warn('[MPL] Errore durante sync premium:', error);
      }
      
      // Stop dopo 1 minuto
      if (attempts >= maxAttempts) {
        clearInterval(interval);
        console.log('[MPL] Premium status check timeout. Manual login required.');
        
        // Aggiorna messaggio con link manuale
        messageEl.innerHTML += 
          '<br><br><small>Non vedi l\'upgrade? <a href="login.html">Fai login</a> per sincronizzare.</small>';
      }
    }, 5000); // Controlla ogni 5 secondi
  }
  
  // Avvia check solo se URL contiene ?purchase=success
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('purchase') === 'success') {
    checkPremiumStatus();
  }
</script>
```

**Poi aggiorna link Gumroad per includere parametro:**

Nel tuo prodotto Gumroad ‚Üí Settings ‚Üí Redirect URL:
```
https://music-producer-lab.vercel.app/success.html?purchase=success
```

---

## 6Ô∏è‚É£ AGGIUNGERE LOGGING STRUTTURATO AL WEBHOOK

**File:** `/backend/routes/gumroad-webhook.js`

Aggiungi logging dettagliato:

```javascript
// Dopo linea 55-58 (estrazione dati)
console.log('[WEBHOOK] üì• Payload ricevuto:', {
  email,
  purchaseId,
  planTier,
  timestamp: new Date().toISOString(),
  source: req.get('User-Agent')
});

// Dopo linea 72 (validazione Gumroad)
console.log('[WEBHOOK] ‚úÖ Acquisto validato con Gumroad:', {
  purchaseId,
  email,
  validated: true
});

// Dopo linea 91 (controllo duplicati)
if (existing?.purchase_id === purchaseId) {
  console.log('[WEBHOOK] ‚è≠Ô∏è Acquisto gi√† processato:', { email, purchaseId });
  return res.status(200).send("Already processed.");
}

// Dopo linea 112 (upsert successo)
console.log('[WEBHOOK] üíæ Utente aggiornato su Supabase:', {
  email,
  has_paid: true,
  plan_tier: planTier,
  purchase_id: purchaseId,
  timestamp: new Date().toISOString()
});
```

---

## 7Ô∏è‚É£ AGGIUNGERE HEALTH CHECK MIGLIORATO

**File:** `/backend/server.js`

Sostituisci l'health check esistente (linee 12-14):

```javascript
app.get("/api/health", async (req, res) => {
  const checks = {
    service: "music-producer-lab",
    status: "operational",
    timestamp: new Date().toISOString(),
    checks: {}
  };

  // Check Supabase connection
  try {
    const { data, error } = await supabase
      .from("users")
      .select("count", { count: "exact", head: true });
    
    checks.checks.supabase = error ? "offline" : "online";
    if (error) {
      checks.status = "degraded";
      checks.checks.supabaseError = error.message;
    }
  } catch (err) {
    checks.checks.supabase = "error";
    checks.checks.supabaseError = err.message;
    checks.status = "unhealthy";
  }

  // Check environment variables
  checks.checks.env = {
    supabaseUrl: !!process.env.SUPABASE_URL,
    supabaseKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
    gumroadSecret: !!process.env.GUMROAD_SECRET,
    gumroadToken: !!process.env.GUMROAD_ACCESS_TOKEN
  };

  const statusCode = checks.status === "operational" ? 200 : 503;
  res.status(statusCode).json(checks);
});
```

---

## 8Ô∏è‚É£ TEST SCRIPT PER WEBHOOK

**File:** `test-webhook.sh` (nuovo file alla root)

```bash
#!/bin/bash

# Test webhook locale
# Usage: ./test-webhook.sh

set -e

WEBHOOK_URL="${1:-http://localhost:3001/api/gumroad-webhook}"
GUMROAD_SECRET="${GUMROAD_SECRET:-KdDFb6uDI8EgNQJwHzQrU0==}"

# Payload di test
PAYLOAD='email=test@example.com&purchase_id=TEST123&product_name=Music Producer Lab Premium&price=9900'

# Calcola HMAC signature
SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$GUMROAD_SECRET" | awk '{print $2}')

echo "üß™ Testing webhook at: $WEBHOOK_URL"
echo "üì¶ Payload: $PAYLOAD"
echo "üîê Signature: $SIGNATURE"
echo ""

# Invia richiesta
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$WEBHOOK_URL" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -H "X-Gumroad-Signature: $SIGNATURE" \
  -d "$PAYLOAD")

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | head -n-1)

echo "üì° Response:"
echo "Status: $HTTP_CODE"
echo "Body: $BODY"
echo ""

if [ "$HTTP_CODE" = "200" ]; then
  echo "‚úÖ Webhook test SUCCESS"
  exit 0
else
  echo "‚ùå Webhook test FAILED"
  exit 1
fi
```

**Rendi eseguibile:**
```bash
chmod +x test-webhook.sh
```

**Esegui test:**
```bash
# Backend locale
./test-webhook.sh http://localhost:3001/api/gumroad-webhook

# Backend produzione
./test-webhook.sh https://your-backend.com/api/gumroad-webhook
```

---

## 9Ô∏è‚É£ DOCUMENTARE SCHEMA DATABASE

**File:** `/supabase/schema.sql`

Aggiungi commenti alla tabella:

```sql
-- Core users table
create table if not exists public.users (
  id uuid primary key default gen_random_uuid(),
  email text unique not null,
  has_paid boolean not null default false,
  plan_tier text not null default 'free',  -- 'free' | 'premium' | [custom tier name]
  purchase_id text,                        -- Gumroad purchase_id o sale_id
  price numeric(10, 2),                    -- Prezzo pagato (opzionale)
  created_at timestamptz not null default timezone('utc', now()),
  updated_at timestamptz not null default timezone('utc', now())
);

-- Indici per performance
CREATE INDEX IF NOT EXISTS idx_users_email ON public.users(email);
CREATE INDEX IF NOT EXISTS idx_users_purchase_id ON public.users(purchase_id);
CREATE INDEX IF NOT EXISTS idx_users_has_paid ON public.users(has_paid);

-- Commenti per documentazione
COMMENT ON TABLE public.users IS 'Profili utenti con stato premium sincronizzato da Gumroad webhook';
COMMENT ON COLUMN public.users.has_paid IS 'True se utente ha acquistato su Gumroad';
COMMENT ON COLUMN public.users.plan_tier IS 'Tier del piano: free, premium, o nome personalizzato da Gumroad';
COMMENT ON COLUMN public.users.purchase_id IS 'ID univoco dell''acquisto Gumroad per prevenire duplicati';
```

---

## üîü VERIFICA FINALE - CHECKLIST

Dopo aver applicato i fix, verifica:

### Backend
- [ ] `git rm api/gumroad-webhook.js` eseguito
- [ ] `GUMROAD_ACCESS_TOKEN` aggiunto a `.env`
- [ ] Logging migliorato nel webhook
- [ ] Health check risponde correttamente
- [ ] Test script funziona: `./test-webhook.sh`

### Frontend
- [ ] `SUPABASE_URL` e `SUPABASE_ANON_KEY` configurate su Vercel
- [ ] File HTML aggiornati con data-attributes
- [ ] `/success.html` ha sync automatica
- [ ] Login funziona correttamente
- [ ] Dashboard mostra premium/free correttamente

### Supabase
- [ ] Campo `price` aggiunto (se desiderato)
- [ ] Indici creati per performance
- [ ] Commenti documentazione aggiunti
- [ ] Test query funziona:
  ```sql
  SELECT * FROM public.users WHERE has_paid = true;
  ```

### Gumroad
- [ ] Webhook URL configurato
- [ ] Redirect URL success page: `.../success.html?purchase=success`
- [ ] Test webhook inviato con successo
- [ ] Access token generato e salvato

---

## üìû SUPPORTO

Se riscontri problemi dopo questi fix:

1. **Backend non risponde:**
   ```bash
   curl https://your-backend.com/api/health
   ```

2. **Frontend non carica Supabase:**
   - Apri Console browser (F12) ‚Üí Guarda errori
   - Controlla che `window.__SUPABASE_URL__` sia definito

3. **Webhook fallisce:**
   - Controlla log backend
   - Verifica firma HMAC con test script
   - Controlla che `GUMROAD_ACCESS_TOKEN` sia valido

4. **Premium non si attiva:**
   - Verifica record in Supabase:
     ```sql
     SELECT * FROM public.users WHERE email = 'test@example.com';
     ```
   - Controlla `has_paid = true`
   - Fai logout/login per refresh

---

**Fine documento fix immediati**  
Applica nell'ordine per risolvere tutti gli errori bloccanti.
